name: Update Private Extension index

on:
  workflow_call:
env:
  storage_container_url: https://azedgecli.blob.core.windows.net/drop
  sas_token: ${{ secrets.sas_token }}
jobs:
    update_index:
        environment: production
        runs-on: [self-hosted, 1ES.Pool=iotupx-github-hosted-pool, 1ES.ImageOverride=MMSUbuntu20.04]
        steps:
          - name: Download wheel
            id: wheel
            uses: actions/download-artifact@v3
            with:
              name: azure-edge-cli-ext
              path: ./
          - name: Install azcopy
            run: |
              curl -so azcopy.tar.gz -L 'https://aka.ms/downloadazcopy-v10-linux'
              tar -zxvf azcopy.tar.gz --strip 1
          - name: Upload wheel to storage
            run: |
              wheel=$(find *.whl)
              azcopy copy ${{ steps.wheel.outputs.download-path }} '${{ env.storage_container_url }}/$wheel?${{env.sas_token}}'
          - name: Download private index file
            run: |
              azcopy copy '${{ env.storage_container_url }}/index.json' 'index.json'
          - name: Update private index
            run: |
              python -m venv env
              source env/bin/activate
              pip install azdev
              azdev setup -r .
              mkdir azure-cli-extensions/
              mv index.json azure-cli-extensions/
              azdev extension update-index
              cd azure-cli-extensions
              azcopy copy 'index.json' '${{ env.storage_container_url }}/index.json?${{env.sas_token}}'